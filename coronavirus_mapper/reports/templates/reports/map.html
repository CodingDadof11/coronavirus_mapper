{% extends "base.html" %}

{% load i18n %}

{% block content%}
<div id="map" class="h-100 w-100"></div>


<!-- Modal -->
<div class="modal fade" id="reportModal" tabindex="-1" role="dialog" aria-labelledby="reportModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
        <div class="modal-header">
            <strong class="modal-title" id="reportModalLabel">
                ðŸ˜· {% trans "Submit report" %}
            </strong>

            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
            </button>
        </div>

        <div class="modal-body">
            <form id="reportForm">
                <div class="form-group">
                    <label for="id_first_symptomatic">
                        {% trans "First symptomatic" %}
                    </label>
                    <input type="date" name="first_symptomatic" required="required" id="id_first_symptomatic" class="form-control">
                </div>

                <div class="form-group">
                    <label for="id_location_map">
                        {% trans "Location" %}
                    </label>
                    <div id="id_location_map" style="width: 100%"></div>
                    <p id="location_map_validation_message" class="bg-danger text-white mt-2 p-2" style="display: none;">Please choose a location for this report.</p>
                </div>

                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    {% trans "Close" %}
                </button>

                <button type="submit" class="btn btn-primary">
                    {% trans "Submit" %}
                </button>
            </form>
        </div>
    </div>
</div>
{% endblock content %}

{% block extra_js %}
<script>
// user location point
// changes position when user clicks on map
var userLocationPoint = new ol.geom.Point([0, 0]);

function initializeReportModalMap() {
    // remove any old location map
    // to prevent duplicate remder
    $('#id_location_map').empty();
    
    var reportMap = new ol.Map({
        target: 'id_location_map',
        layers: [
            // OSM base map
            new ol.layer.Tile({
                source: new ol.source.OSM()
            }),
            // User location layer
            new ol.layer.Vector({
                source: new ol.source.Vector({
                    features: [
                        new ol.Feature({
                            geometry: userLocationPoint
                        }),
                    ]
                }),
            }),
        ],
        view: new ol.View({
            projection: 'EPSG:4326',
            center: [0, 0],
            zoom: 1
        })
    });

    reportMap.on('click', function (event) {      
        // anonymize location by reducing precision
        var anonymizedLocation = anonymizeLocation(event.coordinate);

        // update location marker position
        userLocationPoint.setCoordinates(anonymizedLocation);
    });
}

/*
Anonymize the location data
by reducing decimal degree precision
*/
function anonymizeLocation(lonLat) {
    var precision = 3;

    // Reduce coordinate accuracy for anonymization
    return lonLat.map(function (coordinate) {
        // how may decimal points to keep
        // fewer is less precise
        return coordinate.toFixed(precision)
    });
}

// Add calendar widget to "first symptomatic" field
// default to today for convenience
// don't allow "future" reports
var firstSymptomaticField = flatpickr("#id_first_symptomatic", {
    defaultDate: 'today',
    maxDate: 'today',
});

var map = new ol.Map({
    target: 'map',
    layers: [
        new ol.layer.Tile({
            source: new ol.source.OSM()
        })
    ],
    view: new ol.View({
        center: [0, 0],
        projection: 'EPSG:4326',
        zoom: 1
    })
});

jQuery.ajax("/reports/reports_json/", {
    success: function (reports) {
        // Add report markers to map
        var reportFeatures = reports.features.map(function (report) {
            var reportPoint = new ol.geom.Point(report.geometry.coordinates);

            return new ol.Feature(reportPoint);
        });

        var source = new ol.source.Vector({
            features: reportFeatures,
        });

        var clusterSource = new ol.source.Cluster({
            source: source,
            distance: 40,
        });

        var clusterLayer = new ol.layer.Vector({
            source: clusterSource,
        });

        map.addLayer(clusterLayer);
    }
});

// Make sure location map renders correctly in modal
$('#reportModal').on('shown.bs.modal', function () {
    initializeReportModalMap();
});

$('#reportForm').submit(function(event) {
    event.preventDefault();

    // format field data for sending to server
    var firstSymptomatic = moment(firstSymptomaticField.selectedDates[0]).format('YYYY-MM-DD');
    var coordinates = userLocationPoint.getCoordinates().map(function (coordinate) {
        return parseFloat(coordinate);
    });

    var reportData = {
        first_symptomatic: firstSymptomatic,
        location: {
            "type": "Point",
            "coordinates": coordinates,
        },
    };

    jQuery.ajax ({
        url: "/reports/reports_json/",
        type: "POST",
        data: JSON.stringify(reportData),
        dataType: "json",
        contentType: "application/json; charset=utf-8",
        success: function(){
            window.location.reload();
        },
        error: function (error) {
            console.log(error);
        }
    });
});
</script>
{% endblock extra_js %}

{% block extra_css %}
<style>
#id_location_map {
    height: 300px;
}
</style>
{% endblock extra_css %}